{"version":3,"file":"test.js","sources":["../../../frontend/src/polyfills/promise.js","../../../frontend/src/plugins/router.js","../../../frontend/src/plugins/utils.js","../../../frontend/src/plugins/render.js","../../../frontend/src/test.js"],"sourcesContent":["// extend Promise finally\nwindow.Promise.prototype.finally = function (callback) {\n    let P = this.constructor\n    return this.then(\n      value => P.resolve(callback()).then(() => value),\n      reason =>\n        P.resolve(callback()).then(() => {\n          throw reason\n        })\n    )\n  }\n  ","import qs from 'qs'\n\nconst router = {\n  query() {\n    let search = document.location.search\n    if (search[0] === '?') {\n      search = search.slice(1)\n    }\n    if (!search) {\n      return {}\n    }\n    return qs.parse(search)\n  }\n}\n\nexport default router\n","import { kebabCase, pick } from 'lodash';\n// omit,\n\nconst computedStyle = (el, style = '') => {\n    let str = style\n    if (Object.keys(style).length) {\n        str = ''\n        Object.keys(style).forEach((key) => {\n            str += `${kebabCase(key)}: ${style[key]};`\n        });\n    }\n    el.style.cssText = str\n}\n\nconst computedElProps = (el, val) => {\n    const props = pick(val, ['textContent', 'src', 'link', 'href', 'content', 'rel', 'class', 'name'])\n    Object.keys(props).forEach((key) => {\n        el[key] = props[key]\n    });\n}\n\nconst computedEl = (el, val, obj) => {\n    if (!el) {\n        let parentEl = val && val.parent ? $(val.parent) : $(\"#app\")\n        el = document.createElement(val.tagName || 'div');\n        parentEl.append(el)\n    }\n    computedStyle(el, val.style)\n    computedElProps(el, val)\n}\n\nexport {\n    computedStyle,\n    computedElProps,\n    computedEl\n}","import \"../polyfills/promise\";\nimport router from \"./router\";\nimport { computedEl } from \"./utils\";\n\nclass Render {\n  constructor({ els = [] } = {}) {\n    this.els = els;\n    this.query = router.query() || {}\n    if(this.query.json) {\n      let jsonQuery = {}\n      try {\n        jsonQuery = JSON.parse(this.query.json) || {}\n      } catch (error) {\n        console.log(error)\n      }\n      this.query = Object.assign(this.query, jsonQuery)\n    }\n    if (+this.query.isSaveFile) {\n      let fileHash = this.query.hash\n      let request = new XMLHttpRequest();\n      request.open(\"get\", `${window.location.origin}/resource/${fileHash}.json`);\n      request.send(null);\n      request.onload = ()=>{\n        if (request.status == 200) {\n            this.query = JSON.parse(request.responseText);\n            this.init();\n        }\n      }\n    } else {\n      this.init();\n    }\n  }\n  _makePreloadTask(src) {\n    return new Promise((resolve, reject) => {\n      const img = new Image();\n      img.src = src;\n      img.onload = () => {\n        resolve();\n      };\n      img.onerror = e => {\n        reject(e);\n      };\n    });\n  }\n  _appendLoadEl() {\n    const div = document.createElement(\"div\");\n    div.id = \"load\";\n    document.body.appendChild(div);\n    console.log(\"海报渲染完毕!\");\n  }\n  init() {\n    this.els.forEach(item => {\n      const el = item.el;\n      const value = this.query[item.field];\n      const obj = {}\n      if (item.refField && item.refField.length) {\n        item.refField.map( key => {\n          obj[key] = this.query[key];\n        })\n      }\n      if (value) {\n        item.update ? item.update(el, value, obj) : computedEl(el, value, obj);\n      }\n    });\n\n    const preloadResources = this.els\n      .filter(item => item.isResource)\n      .map(item => {\n        let src = this.query[item.field];\n        if (item.resourceAttr && typeof item.resourceAttr === \"function\") {\n          src = item.resourceAttr(item.el);\n        }\n        if (src) {\n          console.log(\"resource item.field\", item.field, \"src-->\", src);\n          return this._makePreloadTask(src);\n        }\n      });\n    // TODO: Promise.all 策略? 继续渲染错误图 error专用占用图?\n    Promise.all(preloadResources)\n      .then(() => {\n        this._appendLoadEl();\n      })\n      // TODO: 给一个失败的图片\n      .catch(e => {\n        this._appendLoadEl();\n      });\n  }\n}\n\nexport default Render;\n","import Render from './plugins/render'\r\n\r\nconst els = [\r\n  {\r\n    el: $('.viewport'),\r\n    field: 'vw',\r\n    update(el, val) {\r\n      el.content = val\r\n    }\r\n  },\r\n  {\r\n    el: $('#app'),\r\n    field: 'vw',\r\n    refField: ['vw','vh'],\r\n    update(el, val, obj) {\r\n      el.style.width = `${obj.vw}px`\r\n      el.style.height = `${obj.vh}px`\r\n    }\r\n  },\r\n  {\r\n    el: $('.background'),\r\n    field: 'imageUrl',\r\n    refField: ['vw','vh'],\r\n    isResource: true,\r\n    update(el, val, obj) {\r\n      el.style.width = `${obj.vw}px`\r\n      el.style.height = `${obj.vh}px`\r\n      el.src = val\r\n    }\r\n  },\r\n  {\r\n    el: $('.qrcode'),\r\n    field: 'qrCodeUrl',\r\n    refField: ['point1X','point1Y','point2X','point2Y'],\r\n    update(el, val, obj) {\r\n    //   el.style.backgroundImage = `url(${val})`\r\n      const w = obj.point2X - obj.point1X\r\n      const h = obj.point2Y - obj.point1Y\r\n      el.style.width = `${w}px`\r\n      el.style.height = `${h}px`\r\n      el.src = val\r\n      \r\n      el.style.top = `${obj.point1Y}px`\r\n      el.style.left = `${obj.point1X}px`\r\n    }\r\n  },\r\n  {\r\n    el: $('.user_logo'),\r\n    field: 'userLogo',\r\n    refField: ['point1X','point1Y','point2X','point2Y'],\r\n    update(el, val) {\r\n      el.src = val\r\n      el.textContent = val\r\n    }\r\n  },\r\n  {\r\n    el: $('.user_name'),\r\n    field: 'userName',\r\n    refField: ['point1X','point1Y','point2X','point2Y'],\r\n    update(el, val) {\r\n      el.textContent = val\r\n    }\r\n  },\r\n//   {\r\n//     el: $('.course__img'),\r\n//     field: 'course_image',\r\n//     isResource: true,\r\n//     update(el, val) {\r\n//       el.style.backgroundImage = `url(${val})`\r\n//     }\r\n//   },\r\n  \r\n]\r\n\r\nnew Render({\r\n  els\r\n})\r\n"],"names":["window","Promise","prototype","finally","callback","P","constructor","then","value","resolve","reason","router","query","search","document","location","slice","qs","parse","computedStyle","el","style","str","Object","keys","length","forEach","key","kebabCase","cssText","computedElProps","val","props","pick","computedEl","obj","parentEl","parent","$","createElement","tagName","append","Render","els","json","jsonQuery","JSON","error","console","log","assign","isSaveFile","fileHash","hash","request","XMLHttpRequest","open","origin","send","onload","status","responseText","init","_makePreloadTask","src","reject","img","Image","onerror","e","_appendLoadEl","div","id","body","appendChild","item","field","refField","map","update","preloadResources","filter","isResource","resourceAttr","all","catch","content","width","vw","height","vh","w","point2X","point1X","h","point2Y","point1Y","top","left","textContent"],"mappings":"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"}